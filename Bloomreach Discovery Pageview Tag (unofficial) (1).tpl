___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Bloomreach Discovery Pageview Tag (unofficial)",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "The Bloomreach Pageview tag provides integration options for Bloomreach in GTM for all of it\u0027s pageview types, including all required variables.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "br_acc_id",
    "displayName": "Bloomreach Account ID",
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "br_tr_version",
    "displayName": "Tracker Version ID",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "v1",
        "displayValue": "v1"
      }
    ],
    "simpleValueType": true,
    "help": "Default value is v1"
  },
  {
    "type": "TEXT",
    "name": "br_domain_key",
    "displayName": "Bloomreach Domain Key",
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "br_page_type",
    "displayName": "Page Type",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "conversion",
        "displayValue": "Conversion"
      },
      {
        "value": "category",
        "displayValue": "Category"
      },
      {
        "value": "homepage",
        "displayValue": "Home Page"
      },
      {
        "value": "content",
        "displayValue": "Content"
      },
      {
        "value": "product",
        "displayValue": "Product"
      },
      {
        "value": "other",
        "displayValue": "Other"
      },
      {
        "value": "search",
        "displayValue": "Search"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "br_page_title",
    "displayName": "Page Title",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "br_referrer",
    "displayName": "Document Referrer",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true
  },
  {
    "type": "SELECT",
    "name": "br_orig_ref_url",
    "displayName": "Original Referral URL",
    "macrosInSelect": true,
    "selectItems": [],
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "content",
    "displayName": "Content Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "br_content_cat",
        "displayName": "Content Catalogs",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_content_item_id",
        "displayName": "Content Item ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_content_item_name",
        "displayName": "Content Item Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "category",
    "displayName": "Category Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "br_cat_id",
        "displayName": "Category ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_cat_name",
        "displayName": "Category Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "product",
    "displayName": "Product Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "br_prod_id",
        "displayName": "Product ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_prod_sku",
        "displayName": "Product SKU",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_prod_name",
        "displayName": "Product Name",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "search",
    "displayName": "Search Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "br_search_term",
        "displayName": "Search Term",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversion",
    "displayName": "Conversion Variables",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "br_basket_value",
        "displayName": "Basket Value",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_order_id",
        "displayName": "Order ID / Transaction ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "br_items",
        "displayName": "Basket Items",
        "simpleValueType": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "Debug Options",
    "displayName": "Debug Options",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "debug",
        "checkboxText": "Log debug messages to console",
        "simpleValueType": true
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require the necessary APIs
const logToConsole = require('logToConsole');
const injectScript = require('injectScript');
const queryPermission = require('queryPermission');
const window = require('setInWindow');
const get_url = require('parseUrl');
const encodeUriComponent = require('encodeUriComponent');
// get variables from fields in template
const br_acc_id = data.br_acc_id;
const debug_mode = data.debug;
const br_tracker_version = data.br_tr_version;

// populate the br_data object with basic data
var br_data = br_data || {};
br_data.acct_id = data.br_acc_id; 
br_data.title = data.br_page_title;
br_data.domain_key = data.br_domain_key;
br_data.ptype = data.br_page_type;
br_data.origin_source = 'gtm_tag';
br_data.ref = data.br_referrer;
br_data.orig_ref_url = data.br_orig_ref_url;


if(data.br_page_type == 'content'){
  br_data.item_id = data.br_content_item_id;
  br_data.item_name = data.br_content_item_name;
  br_data.catalogs = [{ name : data.br_content_cat }];
} else if(data.br_page_type == 'category'){
  br_data.cat_id = data.br_cat_id;
  br_data.cat = data.br_cat_name;      
} else if(data.br_page_type == 'product'){
  br_data.prod_name = data.br_prod_name;  
  br_data.prod_id = data.br_prod_id;
  br_data.sku = data.br_prod_sku;      
} else if(data.br_page_type == 'search'){
  br_data.search_term = data.br_search_term;
  br_data.catalogs = [{ name : data.br_content_cat }];    
} else if(data.br_page_type == 'conversion'){
  br_data.is_conversion = 1;
  br_data.basket_value = data.br_basket_value;
  br_data.order_id = data.br_order_id;    
  br_data.basket = {'items': data.br_items };
}

// Get the URL the user input into the text field
const url = "https://cdn.brcdn.com/" + encodeUriComponent(data.br_tr_version) + "/br-trk-" + encodeUriComponent(data.br_acc_id) + ".js";

// If the user chose to log debug output, initialize the logging method
const log = data.debug ? logToConsole : (() => {});
if(debug_mode){
log('Bloomreach: Loading script from ' + url);
}
// If the script loaded successfully, log a message and signal success

const onSuccess = () => {
  if(debug_mode){
    log('Bloomreach: Script loaded successfully.');
    log(br_data);
    }
  data.gtmOnSuccess();
};

// If the script fails to load, log a message and signal failure
const onFailure = () => {
  if(debug_mode){
    log('Bloomreach: Script load failed.');
    log(br_data);
  }  
  data.gtmOnFailure();
};

// If the URL input by the user matches the permissions set for the template,
// inject the script with the onSuccess and onFailure methods as callbacks.
if (queryPermission('inject_script', url)) {
  window('br_data', br_data, true);
  injectScript(url, onSuccess, onFailure);
} else {
  if(debug_mode){
    log('Bloomreach: Script load failed due to permissions mismatch.');
  }
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.brcdn.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "br_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 12-8-2024, 14:57:33


